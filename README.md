# Mockaka

[![CI](https://github.com/IlyaFloppy/mockaka/actions/workflows/ci.yaml/badge.svg)](https://github.com/IlyaFloppy/mockaka/actions/workflows/ci.yaml)
[![Go Report Card](https://goreportcard.com/badge/github.com/IlyaFloppy/mockaka)](https://goreportcard.com/report/github.com/IlyaFloppy/mockaka)
[![Coverage](https://coveralls.io/repos/github/IlyaFloppy/mockaka/badge.svg?branch=master)](https://coveralls.io/github/IlyaFloppy/mockaka?branch=master)
[![MIT License](http://img.shields.io/badge/license-MIT-blue.svg?style=flat)](LICENSE)


## Motivation

Mockaka is a mock server for GRPC services. It uses generated `.pb.go` files to implement gRPC service for you. Intended use is end-to-end testing.
Unlike [GripMock](https://github.com/tokopedia/gripmock) it does not need original proto files and is intended to be used directly from go tests.

## Use

Start with creating new mock:

```go
m := mockaka.New(t)
```

### Mocking a gRPC service

Use `AddService` method with `mockaka.Register` and `RegisterServiceServer` function generated by `protoc`. `AddService` may be chained for convinience.

```go
m := mockaka.
    New(t).
    AddService(mockaka.Register(spb.RegisterStringsServiceServer), []mockaka.Stub{}).
    AddService(mockaka.Register(spb.RegisterStrongsServiceServer), []mockaka.Stub{}).
    AddService(mockaka.Register(spb.RegisterStonksServiceServer), []mockaka.Stub{})
```

### Creating stubs

There are four ways to create stubs.

- `mockaka.NewStub`
- `mockaka.NewMatchStub`
- `mockaka.NewErrStub`
- `mockaka.NewMatchErrStub`

### Running mock server

Use `Run` method followed by defered `Stop` so when test finishes running mock server is stopped and new test can run mock server on same address.
```go
go m.Run(address)
defer m.Stop()
```

### Checking gRPC service response

There are helper functions to check protobuf structs for equality:

- `mockaka.PB` returns a copy of it's argument with all unexported fields set to zero values.
- `mockaka.PBEq` is equivalent to `require.Equal(t, PB(expected), PB(actual), msgAndArgs...)`

### Full example

You can find full example in `example` directory. It contains two services:
- `StringsService` which can `Reverse` strings
- `StringsCacheService` which can also `Reverse` strings calling `StringsService.Reverse`. It uses inmemory cache to lower `StringsService` load. Cache can also be cleared with `Invalidate`.

`StringsService` is mocked to test `StringsCacheService`.
